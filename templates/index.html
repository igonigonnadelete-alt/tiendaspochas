<!DOCTYPE html>
<html>
<head>
  <title>tiendas - tiendaspochas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
  <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@300..800&family=Oswald:wght@200..700&display=swap" rel="stylesheet">
</head>
<body>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-container">
        {% for category, message in messages %}
          <div class="flash flash-{{ category }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}


  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-left">
      <a href="https://www.youtube.com/watch?v=5VX4ZXFZ8_8">
        <img src="{{ url_for('static', filename='logo.png') }}" style="width:40px;">
      </a>
    </div>

    <div class="topbar-center">
      <a href="/"><h1>tiendaspochas</h1></a>
    </div>

    <div class="topbar-right">
      <div class="user-menu">
        {% if session.get("user_id") %}
          <button class="user-btn">
            {{ session["username"] }} ▾
          </button>
          <div class="dropdown">
            <a href="/logout">cerrar sesión</a>
          </div>
        {% else %}
          <button class="user-btn">
            entrar ▾
          </button>
          <div class="dropdown">
            <a href="/login">iniciar sesión</a>
            <a href="/register">registrarse</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>


  <!-- Page layout -->
  <div class="layout">

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="current"><a href="/"><img src="{{ url_for('static', filename='homebtn.png') }}" style="width: 30px;"> <span>tiendas</span></a></div>
      <div><a href="/create"><img src="{{ url_for('static', filename='addbtn.png') }}" style="width: 30px;"> <span>crear</span></a></div>
      <div class="spacing"></div>
      <div><button id="mute-btn" style="display: flex; align-items: center; gap: 10px; width: 100%; background: none; border: none; padding: 10px; cursor: pointer; white-space: nowrap;" title="Mute/Unmute"><img src="{{ url_for('static', filename='mutebtn.png') }}" style="width: 30px;" alt="Mute button"> <span>silenciar</span></button></div>
      {% if session.get("user_id") and session.get("is_admin") %}<div><a href="/admin"><img src="{{ url_for('static', filename='adminbtn.png') }}" style="width: 30px;"> <span>admin</span></a></div>{% else %}<div><a id="ahh-btn" onclick="playClick()"><img src="{{ url_for('static', filename='ahhbtn.png') }}" style="width: 30px;" alt="Ahh button"> <span>ahh</span></a></div>{% endif %}
    </div>

    <!-- Main content -->
    <div class="content">
      <h1>tiendas</h1>
      {% for shop in shops %}
      <div class="shop">
        <img src="{{ shop['image'] }}">
        <div class="shop-txt">
          <h2>{{ shop['title'] }}</h2>
          <h4>{{ shop['username'] }}</h4>
        </div>  
        <h3 class="coords">X: {{ shop['x'] }} Y: {{ shop['y'] }}</h3>
        <div class="shop-votes">
          <div class="votebtns" data-user-vote="{{ shop['user_vote'] }}">
          {% if session.get("user_id") %}
            <button class="vote-btn plus" data-shop-id="{{ shop['id'] }}" data-vote-type="up"><img src="{{ url_for('static', filename='plus.png') }}" style="height: 20px; width: auto;"></button>
            <button class="vote-btn minus" data-shop-id="{{ shop['id'] }}" data-vote-type="down"><img src="{{ url_for('static', filename='minus.png') }}" style="height: 20px; width: auto;"></button>
          {% else %}
            <a href="/login">inicia sesión para votar</a>
          {% endif %}
          </div>
          {% if shop['vote_count'] == 0 %}<span class="vote-count">{{ shop['vote_count'] }}</span>{% endif %}{% if shop['vote_count'] >= 1 %}<span class="vote-count positive">{{ shop['vote_count'] }}</span>{% endif %}{% if -1 >= shop['vote_count'] %}<span class="vote-count negative">{{ shop['vote_count'] }}</span>{% endif %}
        </div>
      </div>
      {% else %}
      <a href="/create" class="hidden"><h1 class="fill">no hay tiendas :c</h1></a>
      {% endfor %}
    </div>

  </div>

<audio id="ahh-sound" src="{{ url_for('static', filename='sounds/ahh.mp3') }}"></audio>
<script>
  const clickSound = document.getElementById("ahh-sound");

  function playClick() {
    clickSound.currentTime = 0; // rewind
    clickSound.play();
  }
</script>
<script>
  setTimeout(() => {
  document.querySelectorAll(".flash").forEach(el => {
    el.classList.add("hide");
    setTimeout(() => el.remove(), 500);
  });
}, 4000);
</script>
<script>
  document.querySelectorAll('.vote-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const shopId = btn.dataset.shopId;
      const voteType = btn.dataset.voteType;
      const voteBtnsContainer = btn.closest('.votebtns');
      const voteCountSpan = btn.closest('.shop').querySelector('.vote-count');
      
      if (!voteCountSpan || !voteBtnsContainer) return;
      
      const currentCount = parseInt(voteCountSpan.textContent);
      const previousUserVote = parseInt(voteBtnsContainer.dataset.userVote);
      const newUserVote = voteType === 'up' ? 1 : -1;
      const voteDifference = newUserVote - previousUserVote;
      const optimisticCount = currentCount + voteDifference;
      
      voteCountSpan.textContent = optimisticCount;
      voteCountSpan.className = 'vote-count';
      if (optimisticCount > 0) {
        voteCountSpan.classList.add('positive');
      } else if (optimisticCount < 0) {
        voteCountSpan.classList.add('negative');
      }
      
      try {
        const response = await fetch(`/vote/${shopId}/${voteType}`, { method: 'POST' });
        if (response.ok) {
          const data = await response.json();
          voteBtnsContainer.dataset.userVote = data.user_vote;
          voteCountSpan.textContent = data.vote_count;
          voteCountSpan.className = 'vote-count';
          if (data.vote_count > 0) {
            voteCountSpan.classList.add('positive');
          } else if (data.vote_count < 0) {
            voteCountSpan.classList.add('negative');
          }
        }
      } catch (err) {
        console.error('Vote failed:', err);
        voteCountSpan.textContent = currentCount;
        voteCountSpan.className = 'vote-count';
        if (currentCount > 0) {
          voteCountSpan.classList.add('positive');
        } else if (currentCount < 0) {
          voteCountSpan.classList.add('negative');
        }
      }
    });
  });
</script>
<script src="{{ url_for('static', filename='audio-manager.js') }}"></script>
<script>
  document.getElementById('mute-btn').addEventListener('click', () => {
    audioManager.toggleMute();
  });
</script>
</body>
</html>
